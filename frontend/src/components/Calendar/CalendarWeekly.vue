<template>
  <div class="p-4 h-[90%]">
    <div class="h-full min-h-[500px] min-w-[600px] overflow-auto">
      <!-- Day List -->
      <div class="flex">
        <div class="w-16"></div>
        <div class="grid grid-cols-7 w-full mb-2">
          <span
            v-for="date in weeklyDates"
            class="text-center text-gray-600 text-sm"
            :class="
              new Date(date).toDateString() === new Date().toDateString()
                ? 'font-bold'
                : 'font-normal'
            "
          >
            {{ parseDateWithDay(date) }}
          </span>
        </div>
      </div>

      <div class="border-[1px] h-8">
        <p class="w-16 text-center">All Day</p>
      </div>

      <div
        class="border-l-[1px] border-b-[1px] w-full overflow-scroll flex"
        ref="gridRef"
      >
        <!-- Time List form 0 - 24 -->
        <div class="grid grid-cols-1 h-full w-16">
          <span
            v-for="time in 24"
            class="text-center text-gray-600 font-normal text-sm flex items-end justify-center h-[72px]"
            :style="{ height: `${hourHeight}px` }"
          />
        </div>

        <!-- Grid -->
        <div class="grid grid-cols-7 w-full">
          <!-- full day events -->
          <div v-for="(date, idx) in weeklyDates">
            <div
              class="w-full border-b-[1px] border-r-[1px] border-gray-200 flex flex-col gap-1 transition-all"
              :class="[idx === 0 && 'border-l-[1px] relative']"
              ref="allDayCells"
              :data-date-attr="date"
            >
              <Button
                v-if="showCollapsable"
                @click="isCollapsed = !isCollapsed"
                class="absolute -left-[42px] bottom-[4px] font-bold cursor-pointer"
                :icon="isCollapsed ? 'chevron-down' : 'chevron-up'"
                variant="ghost"
                size="lg"
              />
              <div class="w-full" v-if="!isCollapsed">
                <CalendarEvent
                  v-for="(calendarEvent, idx) in fullDayEvents[parseDate(date)]"
                  class="cursor-pointer w-[90%] mb-1"
                  :event="{ ...calendarEvent, idx }"
                  :key="calendarEvent.id"
                  :date="date"
                />
              </div>
              <div v-else class="flex flex-col justify-between">
                <!-- TODO:show more calendar event component -->
                <ShowMoreCalendarEvent
                  v-if="fullDayEvents[parseDate(date)]?.length > 0"
                  :event="fullDayEvents[parseDate(date)][0]"
                  :date="date"
                  :totalEventsCount="fullDayEvents[parseDate(date)].length"
                  @showMoreEvents="isCollapsed = !isCollapsed"
                />
              </div>
            </div>
          </div>

          <!-- time events -> not full day events -->
          <div
            v-for="(date, idx) in weeklyDates"
            class="border-r-[1px] relative"
            :class="idx === 0 && 'calendar-column'"
            :data-date-attr="date"
          >
            <!-- Time Grid -->
            <div
              class="flex relative cell cursor-pointer"
              v-for="time in twentyFourHoursFormat"
              :data-time-attr="time"
              @dblclick="openNewEventModal($event, time)"
            >
              <div
                class="w-full border-b-[1px] border-gray-200"
                :style="{ height: `${hourHeight}px` }"
              />
            </div>

            <!-- Calendar Events populations  -->
            <CalendarEvent
              v-for="(calendarEvent, idx) in parsedData[parseDate(date)]"
              class="mb-2 cursor-pointer absolute w-[90%]"
              :event="calendarEvent"
              :key="calendarEvent.id"
              :date="date"
            />

            <!-- Current time style  -->
            <div
              class="pl-2 absolute top-20 w-full z-50"
              v-if="new Date(date).toDateString() === new Date().toDateString()"
              :style="setCurrentTime"
            >
              <div class="h-0.5 bg-red-600 current-time relative" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <NewEventModal
    v-if="showEventModal"
    v-model="showEventModal"
    :event="newEvent"
  />
</template>
<script setup>
import { computed, ref, onMounted, reactive, watch } from 'vue'
import CalendarEvent from './CalendarEvent.vue'
import NewEventModal from './NewEventModal.vue'
import {
  calculateMinutes,
  convertMinutesToHours,
  twentyFourHoursFormat,
  findOverlappingEventsCount,
  parseDateWithDay,
  parseDate,
  groupBy,
} from './calendarUtils'
import Button from 'frappe-ui/src/components/Button.vue'
import ShowMoreCalendarEvent from './ShowMoreCalendarEvent.vue'

let props = defineProps({
  events: {
    type: Object,
    required: true,
  },
  config: {
    type: Object,
  },
  weeklyDates: {
    type: Array,
    required: false,
  },
})

const gridRef = ref(null)
const allDayCells = ref(null)
const showCollapsable = ref(false)
const isCollapsed = ref(false)

watch(isCollapsed, (newVal) => {
  if (newVal) {
    allDayCells.value.forEach((cell) => {
      cell.style.height = '56px'
    })
  } else {
    setFullDayEventsHeight(fullDayEvents.value, props.weeklyDates)
  }
})

onMounted(() => {
  let scrollTop = props.config.scrollToHour * 60 * minuteHeight
  gridRef.value.scrollBy(0, scrollTop)
})

let hourHeight = props.config.hourHeight
let minuteHeight = hourHeight / 60

const setCurrentTime = computed(() => {
  let d = new Date()
  let hour = d.getHours()
  let minutes = d.getMinutes()
  let top = (hour * 60 + minutes) * minuteHeight + 'px'
  return { top }
})

const parsedData = computed(() => {
  let groupByDate = groupBy(props.events, (row) => row.date)
  let sortedArray = {}

  for (const [key, value] of Object.entries(groupByDate)) {
    value.forEach((task) => {
      task.startTime = calculateMinutes(task.from_time)
      task.endTime = calculateMinutes(task.to_time)
    })
    let sortedEvents = value
      .filter((event) => !event.isFullDay)
      .sort((a, b) => a.startTime - b.startTime)

    sortedArray[key] = findOverlappingEventsCount(sortedEvents)
  }

  return sortedArray
})

const fullDayEvents = computed(() => {
  let fullDay = props.events.filter((event) => event.isFullDay)
  let dateGroup = groupBy(fullDay, (row) => row.date)
  return dateGroup
})
const getCellHeight = (length) => 49 + 36 * (length - 1)
function getEventsInCurrentWeek(eventsObject, weeklyDates) {
  let currentWeekEvents = {}
  let weeklyFullDayEvents = Object.keys(eventsObject)
  weeklyDates.forEach((date) => {
    date = parseDate(date)

    if (weeklyFullDayEvents.includes(date)) {
      currentWeekEvents[date] = eventsObject[date]
    }
  })
  return currentWeekEvents
}

function maxFullDayEventsInWeek(eventsObject) {
  let lengthArray = []
  Object.values(eventsObject).forEach((events) => {
    lengthArray.push(events.length)
  })
  let maxEvents = Math.max(...lengthArray, 1)
  return maxEvents
}

function setFullDayEventsHeight(eventsObject, weeklyDates) {
  let currentWeekEvents = getEventsInCurrentWeek(eventsObject, weeklyDates)
  let maxEvents = maxFullDayEventsInWeek(currentWeekEvents)
  if (maxEvents > 3) {
    showCollapsable.value = true
  } else {
    showCollapsable.value = false
  }
  let height = getCellHeight(maxEvents)
  if (isCollapsed.value) return
  allDayCells.value.forEach((cell) => {
    cell.style.height = height + 'px'
  })
}

onMounted(() => {
  setFullDayEventsHeight(fullDayEvents.value, props.weeklyDates)
})

watch(
  () => fullDayEvents.value,
  (newFullDayEvents) => {
    setFullDayEventsHeight(newFullDayEvents, props.weeklyDates)
  }
)

watch(
  () => props.weeklyDates,
  (newWeeklyDates) => {
    setFullDayEventsHeight(fullDayEvents.value, newWeeklyDates)
  }
)

const showEventModal = ref(false)
const newEvent = reactive({
  date: '',
  participant: '',
  from_time: '',
  to_time: '',
  venue: '',
  title: '',
})
function openNewEventModal(event, from_time) {
  if (!props.config.isEditMode) return
  let date = event.target.parentNode.parentNode.getAttribute('data-date-attr')
  let to_time = convertMinutesToHours(calculateMinutes(from_time) + 60).slice(
    0,
    -3
  )

  newEvent.date = parseDate(new Date(date))
  newEvent.from_time = from_time
  newEvent.to_time = to_time
  showEventModal.value = true
}
</script>

<style>
.calendar-column {
  border-left: 1px solid #e5e5e5;
}

.calendar-column ::before {
  content: attr(data-time-attr);
  position: absolute;
  left: -45px;
  top: -9px;
  font-size: 12px;
  font-weight: 400;
}

.current-time::before {
  content: '';
  display: block;
  width: 12px;
  height: 12px;
  background-color: red;
  border-radius: 50%;
  position: absolute;
  left: -8px;
  top: -5px;
}
</style>
